name: life check
on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches:
      - master
      - AddActions4life
env:
  MYNAME: hinoshiba
jobs:
    setup:
      runs-on: ubuntu-latest
      outputs:
        Weekid: ${{ steps.date.outputs.Weekid }}
      steps:
      - name: Get current week-id
        id: date
        run: echo "Weekid=$(date +'%Y%U')" >> "$GITHUB_OUTPUT"
    check:
      runs-on: ubuntu-latest
      needs: setup
      steps:
      - name: Checkout from repository.
        uses: actions/checkout@v2
      - name: Check a latest version.
        id: env
        run: |
            curl -L -s --request GET --url https://endoflife.date/api/golang/1.21.json --header 'Accept: application/json' > /tmp/version.json
            echo "Version=$(cat /tmp/version.json | jq '.latest')" >> "$GITHUB_OUTPUT"
            echo "IsEol=$(cat /tmp/version.json | jq '.eol')" >> "$GITHUB_OUTPUT"
      - name: Update
        id: need_update
        run: |
            cp dockerfiles/golang/Dockerfile /tmp/Dockerfile_bk
            version=${{steps.env.outputs.Version}}; sed -i 's/golang:[0-9.]*\s/golang:'${version}' /' dockerfiles/golang/Dockerfile
            diff -q /tmp/Dockerfile_bk dockerfiles/golang/Dockerfile
        continue-on-error: true
      - name: CreatePR
        uses: peter-evans/create-pull-request@v5
        with:
          title: '[Example] Update report'
        if: steps.need_update.outcome == 'success'
      - name: die
        run: test "false" == "${{steps.env.outputs.IsEol}}" && exit 1
